<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.himedia.groupware.dao.IMailDao">
    <select id="getRecentSendMail" resultType="com.himedia.groupware.dto.MailDto">
        select * from mail_view where senderid=#{id}
        order by indate desc limit 3
    </select>
    <select id="getRecentReceiveMail" resultType="com.himedia.groupware.dto.MailDto">
        select * from mail_view where receiverid=#{id}
        order by indate desc limit 3
    </select>
    <select id="getAllCountForReceiveMail" resultType="_int">
        select count(*) from mail_view where receiverid=#{id} and subject like concat('%', #{key}, '%')
    </select>
    <select id="getAllCountForSendMail" resultType="_int">
        select count(*) from mail_view where senderid=#{id} and subject like concat('%', #{key}, '%')
    </select>
    <select id="getReceiveMail" resultType="com.himedia.groupware.dto.MailDto">
        select * from mail_view where receiverid=#{id} and subject like concat('%', #{key}, '%')
        order by indate desc
    </select>
    <select id="getSendMail" resultType="com.himedia.groupware.dto.MailDto">
        select * from mail_view where senderid=#{id} and subject like concat('%', #{key}, '%')
        order by indate desc
    </select>
    <select id="getMail" resultType="com.himedia.groupware.dto.MailDto">
        select * from mail_view where id=#{id}
    </select>
    <update id="setRead">
        update mail set `read` = 1 where id=#{id}
    </update>
    <select id="getRepliedList" resultType="com.himedia.groupware.dto.MailDto">
        select * from mail_view where reply=#{id}
    </select>
    <insert id="insertMail" parameterType="com.himedia.groupware.dto.MailDto">
        insert into mail(senderid, receiverid, subject, content, reply)
        values(#{senderId}, #{receiverId}, #{subject}, #{content}, #{reply})
    </insert>
    <update id="deleteReply">
        update mail set reply=0 where reply=#{id}
    </update>
    <delete id="deleteMail">
        delete from mail where id=#{id}
    </delete>
    <select id="countMailToday" resultType="_int">
        select count(*) from mail where receiverid=#{id} and date(indate) = curdate();
    </select>
    <select id="getLatestMail" resultType="com.himedia.groupware.dto.MailDto">
        select * from mail where senderid=${senderid} order by indate desc limit 1
    </select>
    <update id="setNotified">
        update mail set notified = #{notified} where id=#{id}
    </update>
    <select id="countUnnotified" resultType="_int">
        select count(*) from mail where receiverid=#{id} and notified=0
    </select>
    <update id="clearUnnotified">
        update mail set notified=1 where receiverid=#{id} and notified=0
    </update>
</mapper>